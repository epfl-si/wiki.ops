# =============================================================================
# Playbook de déploiement polywiki
# =============================================================================
#
# Usage:
#   # Déploiement complet sur la production
#   wikisible
#
#   # Déploiement avec mise à jour forcée
#   wikisible -e "polywiki_force_update=true"
#
#   # Déploiement avec une version spécifique
#   wikisible -e "polywiki_version=2024-01-15"
#
#   # Dry-run (check mode)
#   wikisible --check
#
#   # Deployer uniquement l'application (sans Tomcat ni Apache config)
#   wikisible --tags app
#
#   # Deployer uniquement la config Tomcat
#   wikisible --tags tomcat
#
#   # Deployer uniquement la config Apache
#   wikisible --tags apache
#
#   # Déploiement sans Apache (pour test)
#   wikisible --skip-tags apache
#
#   # Déploiement uniquement setup + Tomcat + App (sans Apache)
#   wikisible --tags users,tomcat,app
#
# =============================================================================

- hosts: vms
  gather_facts: no
  roles:
    - epfl_si.katello_dsi.katello_fleet_member
    - roles/wiki-vm
    - role: roles/rhel-apache-tomcat
      vars:
        apache_tomcat_dn_cn: "{{ inventory_web_hostname }}"

- hosts: vms-test
  gather_facts: no
  roles:
    - roles/wiki-build

- hosts: vms-prod
  gather_facts: no
  tasks:
    - tags: install
      include_role:
        name: roles/wiki-build
        tasks_from: install.yml

- hosts: vms
  gather_facts: no
  roles:
    - roles/wiki-app
