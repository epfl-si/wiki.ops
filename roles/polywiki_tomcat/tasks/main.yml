---
# =============================================================================
# Rôle polywiki_tomcat - Configuration Tomcat pour polywiki
# =============================================================================

- name: Ensure Tomcat conf directory exists
  ansible.builtin.file:
    path: "{{ polywiki_tomcat_conf_dir }}"
    state: directory
    owner: "{{ polywiki_tomcat_owner }}"
    group: "{{ polywiki_tomcat_group }}"
    mode: "0755"

- name: Create tomcat-users.xml (required by server.xml)
  ansible.builtin.copy:
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <!-- Managed by Ansible - do not edit manually -->
      <tomcat-users xmlns="http://tomcat.apache.org/xml"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://tomcat.apache.org/xml
                    http://tomcat.apache.org/xml/tomcat-users.xsd"
                    version="1.0">
        <!-- No users defined by default -->
      </tomcat-users>
    dest: "{{ polywiki_tomcat_conf_dir }}/tomcat-users.xml"
    owner: "{{ polywiki_tomcat_owner }}"
    group: "{{ polywiki_tomcat_group }}"
    mode: "0640"

- name: Deploy server.xml
  ansible.builtin.template:
    src: server.xml.j2
    dest: "{{ polywiki_tomcat_conf_dir }}/server.xml"
    owner: "{{ polywiki_tomcat_owner }}"
    group: "{{ polywiki_tomcat_group }}"
    mode: "0644"
    backup: true
  notify: restart tomcat

- name: Deploy HTTP connector configuration
  ansible.builtin.template:
    src: connector-http.xml.j2
    dest: "{{ polywiki_tomcat_conf_dir }}/connector-http-{{ polywiki_tomcat_http_port }}-wiki.xml"
    owner: "{{ polywiki_tomcat_owner }}"
    group: "{{ polywiki_tomcat_group }}"
    mode: "0644"
  notify: restart tomcat

# =============================================================================
# Fichiers de configuration essentiels pour CATALINA_BASE multi-instance
# Ces fichiers doivent être copiés de CATALINA_HOME car Tomcat ne les trouve
# pas automatiquement quand CATALINA_BASE != CATALINA_HOME
# =============================================================================

- name: Copy catalina.properties from CATALINA_HOME
  ansible.builtin.copy:
    src: "{{ polywiki_tomcat_home }}/conf/catalina.properties"
    dest: "{{ polywiki_tomcat_conf_dir }}/catalina.properties"
    owner: "{{ polywiki_tomcat_owner }}"
    group: "{{ polywiki_tomcat_group }}"
    mode: "0644"
    remote_src: true
  notify: restart tomcat

- name: Copy context.xml from CATALINA_HOME
  ansible.builtin.copy:
    src: "{{ polywiki_tomcat_home }}/conf/context.xml"
    dest: "{{ polywiki_tomcat_conf_dir }}/context.xml"
    owner: "{{ polywiki_tomcat_owner }}"
    group: "{{ polywiki_tomcat_group }}"
    mode: "0644"
    remote_src: true
  notify: restart tomcat

- name: Copy web.xml from CATALINA_HOME (defines default servlet)
  ansible.builtin.copy:
    src: "{{ polywiki_tomcat_home }}/conf/web.xml"
    dest: "{{ polywiki_tomcat_conf_dir }}/web.xml"
    owner: "{{ polywiki_tomcat_owner }}"
    group: "{{ polywiki_tomcat_group }}"
    mode: "0644"
    remote_src: true
  notify: restart tomcat

# =============================================================================
# Service systemd pour l'instance Tomcat
# =============================================================================

- name: Ensure temp directory exists for PID file
  ansible.builtin.file:
    path: "{{ polywiki_tomcat_base_dir }}/temp"
    state: directory
    owner: "{{ polywiki_tomcat_owner }}"
    group: "{{ polywiki_tomcat_group }}"
    mode: "0755"

- name: Deploy systemd service file
  ansible.builtin.template:
    src: tomcat-wiki.service.j2
    dest: /etc/systemd/system/{{ polywiki_tomcat_service_name }}.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - reload systemd daemon
    - restart tomcat

- name: Reload systemd daemon after service file deployment
  ansible.builtin.systemd:
    daemon_reload: true
  when: not ansible_check_mode

- name: Ensure Tomcat service is enabled and running
  ansible.builtin.systemd:
    name: "{{ polywiki_tomcat_service_name }}"
    state: started
    enabled: true
  ignore_errors: "{{ ansible_check_mode }}"
