---
# =============================================================================
# Rôle polywiki_apache - Configuration Apache pour polywiki
# =============================================================================

# =============================================================================
# Certificats SSL auto-signés (si HTTPS activé)
# =============================================================================

- name: Ensure SSL directory exists
  ansible.builtin.file:
    path: "{{ polywiki_ssl_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0750"
  when: polywiki_apache_enable_https | default(false)

- name: Generate self-signed SSL certificate
  ansible.builtin.command:
    cmd: >
      openssl req -x509 -nodes -days 365 -newkey rsa:2048
      -keyout {{ polywiki_ssl_key_file }}
      -out {{ polywiki_ssl_cert_file }}
      -subj "/C=CH/ST=Vaud/L=Lausanne/O=EPFL/CN={{ polywiki_apache_server_name }}"
      -addext "subjectAltName=DNS:{{ polywiki_apache_server_name }},DNS:wikis.epfl.ch"
    creates: "{{ polywiki_ssl_cert_file }}"
  when: polywiki_apache_enable_https | default(false)

- name: Copy certificate as chain file
  ansible.builtin.copy:
    src: "{{ polywiki_ssl_cert_file }}"
    dest: "{{ polywiki_ssl_chain_file }}"
    remote_src: true
    owner: root
    group: root
    mode: "0644"
  when: polywiki_apache_enable_https | default(false)

- name: Set SSL key permissions
  ansible.builtin.file:
    path: "{{ polywiki_ssl_key_file }}"
    owner: root
    group: root
    mode: "0600"
  when: polywiki_apache_enable_https | default(false)

# =============================================================================
# Configuration Apache
# =============================================================================

- name: Ensure required Apache modules are loaded
  ansible.builtin.lineinfile:
    path: /etc/httpd/conf.modules.d/00-proxy.conf
    line: "{{ item }}"
    create: true
    mode: "0644"
  loop:
    - "LoadModule proxy_module modules/mod_proxy.so"
    - "LoadModule proxy_http_module modules/mod_proxy_http.so"
    - "LoadModule headers_module modules/mod_headers.so"
    - "LoadModule rewrite_module modules/mod_rewrite.so"
  notify: reload apache

- name: Deploy polywiki VirtualHost configuration
  ansible.builtin.template:
    src: polywiki-vhost.conf.j2
    dest: "{{ polywiki_apache_conf_dir }}/polywiki.conf"
    owner: root
    group: root
    mode: "0644"
  notify: reload apache

- name: Deploy polywiki proxy configuration
  ansible.builtin.template:
    src: polywiki-proxy.conf.j2
    dest: "{{ polywiki_apache_conf_dir }}/polywiki-proxy.conf"
    owner: root
    group: root
    mode: "0644"
  notify: reload apache

# Nettoyer les fichiers de config obsolètes/temporaires
- name: Remove obsolete Apache config files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ polywiki_apache_conf_dir }}/polywiki-ssl.conf"  # Config HTTPS temporaire
    - "{{ polywiki_apache_conf_dir }}/wiki.conf"          # Ancienne config en conflit
  notify: reload apache

- name: Ensure Apache is running and enabled
  ansible.builtin.service:
    name: "{{ polywiki_apache_service_name }}"
    state: started
    enabled: true

