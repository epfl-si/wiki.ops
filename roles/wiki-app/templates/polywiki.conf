# Managed by Ansible - do not edit manually
################################################################################
# polywiki VirtualHost configuration
################################################################################

# HTTP VirtualHost
<VirtualHost *:80>
    ServerName {{ inventory_web_hostname }}
{% for alias in apache_server_aliases %}
{%   if alias != inventory_web_hostname %}
    ServerAlias {{ alias }}
{%   endif %}
{% endfor %}

    # Logging
    ErrorLog {{ apache_logs_dir }}/error.log
    CustomLog {{ apache_logs_dir }}/access.log combined
    LogLevel warn
    ServerSignature Off

{% if apache_enable_https | default(true) %}
    # Force HTTPS redirect
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^/(.*)$ https://%{SERVER_NAME}/$1 [L,R=301]
{% else %}
    # HTTPS disabled - serve application directly on HTTP
    # Document root (for static files if needed)
    DocumentRoot "{{ apache_document_root }}"

    # Character encoding
    AddDefaultCharset ISO-8859-1

    # Include proxy and rewrite rules
    Include {{ apache_conf_d_directory }}/polywiki-proxy.conf
{% endif %}
</VirtualHost>

{% if apache_enable_https | default(true) %}
# HTTPS - Main configuration
<VirtualHost *:443>
    ServerName {{ inventory_web_hostname }}
{% for alias in apache_server_aliases %}
{%   if alias != inventory_web_hostname %}
    ServerAlias {{ alias }}
{%   endif %}
{% endfor %}

    # Document root (for static files if needed)
    DocumentRoot "{{ apache_document_root }}"

    # Logging
    ErrorLog {{ apache_logs_dir }}/error.log
    CustomLog {{ apache_logs_dir }}/access.log combined
    LogLevel warn
    ServerSignature Off

    # Character encoding
    AddDefaultCharset ISO-8859-1

    # SSL Configuration (certificats auto-signés générés par Ansible)
    SSLEngine on
    SSLCertificateFile      "{{ apache_tls_cert }}"
    SSLCertificateKeyFile   "{{ apache_tls_key }}"

    # SSL Protocol and Ciphers (modern configuration)
    SSLProtocol ALL -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK
    SSLHonorCipherOrder on

    # Include proxy and rewrite rules
    Include {{ apache_conf_d_directory }}/polywiki-proxy.conf
</VirtualHost>
{% endif %}
