# Managed by Ansible - do not edit manually
################################################################################
# polywiki Proxy and Rewrite configuration
################################################################################

# Enable rewrite engine
RewriteEngine On

# Normalize hostname - redirect all requests to canonical hostname
RewriteCond %{HTTP_HOST}   !^{{ inventory_web_hostname | regex_escape() }}$ [NC]
{% if apache_enable_https | default(true) %}
RewriteRule (.*) https://{{ inventory_web_hostname }}$1 [R=301,L]
{% else %}
RewriteRule (.*) http://{{ inventory_web_hostname }}$1 [R=301,L]
{% endif %}

# Rewrite for the documents
# /wikiname/documents/path -> /public/documents/wikiname/path
RewriteCond %{REQUEST_URI}  !^/public/documents.*
RewriteRule ^/([a-z0-9\.\-]+)/documents/(.*)  http://localhost:{{ wiki_tomcat_servlet_port }}/public/documents/$1/$2  [P,L]

# Rewrite for the pages urls
# /wikiname/pagename -> /public/page/view.go?wikiName=wikiname&pageName=pagename
RewriteCond %{REQUEST_URI}  !^/$
RewriteCond %{REQUEST_URI}  !^/(favicon.ico|noindex/|private/|public/|robots.txt|test.txt|rss/|static/).*
RewriteCond %{REQUEST_URI}  !^/auth/.*
RewriteRule ^/([a-z0-9\.\-]+)/?(.*)   http://localhost:{{ wiki_tomcat_servlet_port }}/public/page/view.go?wikiName=$1&pageName=$2  [P,L]

################################################################################
# Reverse proxy to Tomcat
################################################################################

# Preserve the original Host header
ProxyPreserveHost On

# Main proxy rules
ProxyPass / http://localhost:{{ wiki_tomcat_servlet_port }}/
ProxyPassReverse / http://localhost:{{ wiki_tomcat_servlet_port }}/
# Forward protocol headers to Tomcat (required for OIDC redirect_uri)
<Location />
{% if apache_enable_https | default(true) %}
    # Apache gère HTTPS directement
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
{% else %}
    # Load balancer fait le SSL termination - les requêtes arrivent en HTTP mais étaient HTTPS
    # Le load balancer devrait déjà envoyer X-Forwarded-Proto: https, sinon on le définit
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
{% endif %}
    RequestHeader set X-Forwarded-Host "{{ inventory_web_hostname }}"
</Location>

